version: "3.8"

services:
  consul:
    image: consul:1.9.5
    container_name: consul
    ports:
      - "8500:8500"

  frontend:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: frontend
    ports:
      - "5000:5000"
    environment:
      - JAEGER_SAMPLE_RATIO=1
      - LOG_LEVEL=info
    volumes:
      - ./config.json:/config.json
    depends_on:
      - consul
    restart: always

  profile:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: profile
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - mongodb-profile
      - memcached-profile
      - consul
    restart: always

  search:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: search
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - consul
    restart: always

  geo:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: geo
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - mongodb-geo
      - consul
    restart: always

  rate:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: rate
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - mongodb-rate
      - memcached-rate
      - consul
    restart: always

  recommendation:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: recommendation
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - mongodb-recommendation
      - consul
    restart: always

  user:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: user
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - mongodb-user
      - consul
    restart: always

  reservation:
    build: .
    image: deathstarbench/hotel-reservation:latest
    entrypoint: reservation
    environment:
      - JAEGER_SAMPLE_RATIO=1
    volumes:
      - ./config.json:/config.json
    depends_on:
      - mongodb-reservation
      - memcached-reserve
      - consul
    restart: always

  jaeger:
    image: jaegertracing/all-in-one:1.22
    container_name: jaeger
    ports:
      - "16686:16686"
      - "6831:6831/udp"

  # --- Databases & Caches with correct network aliases ---

  memcached-rate:
    image: memcached:latest
    restart: always
    networks:
      default:
        aliases:
          - memcached-rate

  memcached-profile:
    image: memcached:latest
    restart: always
    networks:
      default:
        aliases:
          - memcached-profile

  memcached-reserve:
    image: memcached:latest
    restart: always
    networks:
      default:
        aliases:
          - memcached-reserve
          - memcached-reservation

  mongodb-geo:
    image: mongo:5.0
    restart: always
    networks:
      default:
        aliases:
          - mongodb-geo
          - geo-db

  mongodb-profile:
    image: mongo:5.0
    restart: always
    networks:
      default:
        aliases:
          - mongodb-profile
          - profile-db

  mongodb-rate:
    image: mongo:5.0
    restart: always
    networks:
      default:
        aliases:
          - mongodb-rate
          - rate-db

  mongodb-recommendation:
    image: mongo:5.0
    restart: always
    networks:
      default:
        aliases:
          - mongodb-recommendation
          - recommendation-db

  mongodb-reservation:
    image: mongo:5.0
    restart: always
    networks:
      default:
        aliases:
          - mongodb-reservation
          - reservation-db

  mongodb-user:
    image: mongo:5.0
    restart: always
    networks:
      default:
        aliases:
          - mongodb-user
          - user-db
